version: '3.8'


x-env-scalars:
  - &x-env-meili-master-key ${MEILI_MASTER_KEY}
x-env-vectordb: &x-env-vectordb
  POSTGRES_DB: ${POSTGRES_DB:-librechat}
  POSTGRES_USER: ${POSTGRES_USER:-librechat}
  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
x-env-apikeys: &x-env-apikeys
  #OPENAI_API_KEY: ${OPENAI_API_KEY}
  #ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
  #GOOGLE_KEY: ${GOOGLE_API_KEY:-user_provided}
  #BINGAI_TOKEN: ${BINGAI_TOKEN:-user_provided}
  #ASSISTANTS_API_KEY: ${ASSISTANTS_API_KEY:-user_provided}
  #MISTRAL_API_KEY: ${MISTRAL_API_KEY:-user_provided}
  #GROQ_API_KEY: ${GROQ_API_KEY:-user_provided}
  #PERPLEXITY_API_KEY: ${PERPLEXITY_API_KEY:-user_provided}
  #ANYSCALE_API_KEY: ${ANYSCALE_API_KEY:-user_provided}
  #TOGETHERAI_API_KEY: ${TOGETHERAI_API_KEY:-user_provided}
  DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
  _ : _

services:
  api:
    container_name: librechat
    image: ghcr.io/danny-avila/librechat-dev:latest
    ports:
      - "${PORT:-3080}:${PORT:-3080}"
    depends_on:
      meilisearch:
        condition: service_healthy
      vectordb:
        condition: service_healthy
      rag-api:
        condition: service_started
    restart: always
    user: "${UID:-1000}:${GID:-1000}"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      << : *x-env-apikeys      
      HOST: ${HOST:-0.0.0.0}
      MONGO_URI: mongodb://${MONGO_USERNAME}:${MONGO_PASSWORD}@${MONGO_HOST}:${MONGO_PORT}/${MONGO_DBNAME}?authSource=admin&directConnection=true
      MEILI_HOST: ${MEILI_HOST:-http://meilisearch:7700}
      MEILI_MASTER_KEY: *x-env-meili-master-key
      RAG_PORT: ${RAG_PORT:-8000}
      RAG_API_URL: http://rag-api:${RAG_PORT:-8000}
      DOMAIN_CLIENT: ${DOMAIN_CLIENT}
      DOMAIN_SERVER: ${DOMAIN_SERVER}
      SEARCH: 'true'
      CONFIG_PATH: /config/librechat.yaml
      JWT_SECRET: ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      CREDS_KEY: ${CREDS_KEY}
      CREDS_IV: ${CREDS_IV}
    volumes:
      - type: bind
        source: ./.env
        target: /app/.env
      - 'librechat-images:/app/client/public/images'
      - 'librechat-uploads:/app/uploads'
      - 'librechat-logs:/app/api/logs'
      - 'librechat-config:/app/custom/config'
    healthcheck:
      test:
        - CMD
        - wget
        - --no-verbose
        - --tries=1
        - --spider
        - http://127.0.0.1:${PORT}/api/health
      interval: 5s
      timeout: 10s
      retries: 3
    # post_start:
    #   - command: npm run create-user ${ADMIN_EMAIL} ${ADMIN_PASSWORD}
    #     user: root

  meilisearch:
    image: "getmeili/meilisearch:latest"
    container_name: meilisearch
    user: ${UID:-1000}:${GID:-1000}
    environment:
      MEILI_ENV: production
      MEILI_NO_ANALYTICS: ${MEILI_NO_ANALYTICS:-true}
      MEILI_MASTER_KEY: *x-env-meili-master-key
    volumes:
      - "meilisearch-data:/meili_data"
    restart: always
    healthcheck:
      test:
        - CMD
        - curl
        - "-f"
        - "http://127.0.0.1:7700/health"
      interval: 2s
      timeout: 10s
      retries: 15

  vectordb:
    image: ankane/pgvector:latest
    container_name: vectordb
    user: ${UID:-1000}:${GID:-1000}
    environment:
      << : *x-env-vectordb
    volumes:
      - vectordb-data:/var/lib/postgresql/data
    healthcheck:
      test:
        - CMD
        - pg_isready
        - '--host=127.0.0.1'
        - '--port=5432'
      interval: 2s
      timeout: 1m
      retries: 5
      start_period: 10s
    restart: always

  rag-api:
    image: ghcr.io/danny-avila/librechat-rag-api-dev-lite:latest
    container_name: rag-api
    user: ${UID:-1000}:${GID:-1000}
    environment:
      << : [*x-env-vectordb, *x-env-apikeys]
      DB_HOST: vectordb
      RAG_PORT: ${RAG_PORT:-8000}
    depends_on:
      vectordb:
        condition: service_healthy
    healthcheck:
      test:
        - CMD
        - sh
        - -c
        - "printf 'GET /health HTTP/1.0\r\nHost: 127.0.0.1\r\n\r\n' | nc -w4 127.0.0.1 ${RAG_PORT:-8000}"
      interval: 5s
      timeout: 20s
      retries: 10
    restart: always

volumes:
  meilisearch-data: null
  vectordb-data: null
  librechat-images: null
  librechat-logs: null
  librechat-uploads: null
  librechat-config: null