# ========================================
# Environment Variables & Common Settings
# ========================================

x-env-scalars:
  - &x-env-meili-master-key ${MEILI_MASTER_KEY}

# Vector database environment variables
x-env-vectordb: &x-env-vectordb
  POSTGRES_DB: ${POSTGRES_DB:-librechat}
  POSTGRES_USER: ${POSTGRES_USER:-librechat}
  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}

# AI API keys configuration (most providers disabled)
x-env-apikeys: &x-env-apikeys
  # OpenAI and other providers (commented out)
  #OPENAI_API_KEY: ${OPENAI_API_KEY:-user_provided}
  #ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
  #GOOGLE_KEY: ${GOOGLE_API_KEY:-user_provided}
  #BINGAI_TOKEN: ${BINGAI_TOKEN:-user_provided}
  #ASSISTANTS_API_KEY: ${ASSISTANTS_API_KEY:-user_provided}
  #MISTRAL_API_KEY: ${MISTRAL_API_KEY:-user_provided}
  #GROQ_API_KEY: ${GROQ_API_KEY:-user_provided}
  #PERPLEXITY_API_KEY: ${PERPLEXITY_API_KEY:-user_provided}
  #ANYSCALE_API_KEY: ${ANYSCALE_API_KEY:-user_provided}
  #TOGETHERAI_API_KEY: ${TOGETHERAI_API_KEY:-user_provided}
  #DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-user_provided}
  
  # Web Search APIs
  #TAVILY_API_KEY: ${TAVILY_API_KEY:-user_provided}
  #SERPAPI_API_KEY: ${SERPAPI_API_KEY:-user_provided}
  _ : _

# ========================================
# Services Configuration
# ========================================

services:
  # =====================================
  # Main LibreChat API Service
  # =====================================
  api:
    container_name: api
    image: ghcr.io/danny-avila/librechat-dev:latest
    ports:
      - "${PORT:-3080}:${PORT:-3080}"
    restart: always
    
    # Service dependencies
    depends_on:
      meilisearch:
        condition: service_healthy
      vectordb:
        condition: service_healthy
      rag-api:
        condition: service_started
    
    # Network configuration - API в обеих сетях
    networks:
      - frontend
      - backend
    
    # Network configuration
    extra_hosts:
      - "host.docker.internal:host-gateway"
    
    # Environment variables
    environment:
      << : *x-env-apikeys
      # Server settings
      HOST: "${HOST:-0.0.0.0}"
      DOMAIN_CLIENT: ${DOMAIN_CLIENT}
      DOMAIN_SERVER: ${DOMAIN_SERVER}
      
      # Database connections
      MONGO_URI: "mongodb://${MONGO_USERNAME:-librechat}:${MONGO_PASSWORD}@${MONGO_HOST}:${MONGO_PORT:-27017}/${MONGO_DBNAME:-librechat}?authSource=admin&directConnection=true"
      
      # Search service
      MEILI_HOST: "${MEILI_HOST:-http://meilisearch}:${MEILI_PORT:-7700}"
      MEILI_MASTER_KEY: *x-env-meili-master-key
      SEARCH: 'true'
      
      # RAG API
      RAG_PORT: "${RAG_PORT:-8000}"
      RAG_API_URL: "http://rag-api:${RAG_PORT:-8000}"
      
      # Security
      JWT_SECRET: ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      CREDS_KEY: ${CREDS_KEY}
      CREDS_IV: ${CREDS_IV}
      
      # Configuration
      CONFIG_PATH: /config/librechat.yaml
    
    # Volume mounts
    volumes:
      - type: bind
        source: ./.env
        target: /app/.env
      - 'librechat-images:/app/client/public/images'
      - 'librechat-uploads:/app/uploads'
      - 'librechat-logs:/app/api/logs'
      - 'librechat-config:/app/custom/config'
    
    # Health monitoring
    healthcheck:
      test:
        - CMD
        - wget
        - --no-verbose
        - --tries=1
        - --spider
        - http://127.0.0.1:${PORT:-3080}/api/health
      interval: 5s
      timeout: 10s
      retries: 3
    
    # Post-start admin user creation
    post_start:
      - command:
        - "npm run create-user \"${ADMIN_EMAIL}\" \"${ADMIN_NAME}\" \"${ADMIN_USERNAME}\" \"${ADMIN_PASSWORD}\" -- --email-verified=True 2>&1 | /app/logs/create-user-output.log"

  # =====================================
  # MeiliSearch Service (Full-text Search)
  # =====================================
  meilisearch:
    container_name: meilisearch
    image: "getmeili/meilisearch:latest"
    restart: always
    #user: ${UID:-1000}:${GID:-1000}
    
    # Только backend сеть - изолирован от внешнего мира
    networks:
      - backend
    
    environment:
      MEILI_ENV: production
      MEILI_NO_ANALYTICS: ${MEILI_NO_ANALYTICS:-true}
      MEILI_MASTER_KEY: *x-env-meili-master-key
    
    volumes:
      - "meilisearch-data:/meili_data"
    
    healthcheck:
      test:
        - CMD
        - curl
        - "-f"
        - "http://127.0.0.1:7700/health"
      interval: 2s
      timeout: 10s
      retries: 15

  # =====================================
  # PostgreSQL Vector Database
  # =====================================
  vectordb:
    container_name: vectordb
    image: ankane/pgvector:latest
    restart: always
    #user: ${UID:-1000}:${GID:-1000}
    
    # Только backend сеть - изолирован от внешнего мира
    networks:
      - backend
    
    environment:
      << : *x-env-vectordb
    
    volumes:
      - vectordb-data:/var/lib/postgresql/data
    
    healthcheck:
      test:
        - CMD
        - pg_isready
        - '--host=127.0.0.1'
        - '--port=5432'
      interval: 2s
      timeout: 1m
      retries: 5
      start_period: 10s

  # =====================================
  # RAG API Service (Retrieval-Augmented Generation)
  # =====================================
  rag-api:
    container_name: rag-api
    image: ghcr.io/danny-avila/librechat-rag-api-dev-lite:latest
    restart: always
    #user: ${UID:-1000}:${GID:-1000}
    
    # Только backend сеть - изолирован от внешнего мира
    networks:
      - backend
    
    environment:
      << : [*x-env-vectordb, *x-env-apikeys]
      DB_HOST: vectordb
      RAG_PORT: ${RAG_PORT:-8000}
    
    depends_on:
      vectordb:
        condition: service_healthy
    
    healthcheck:
      test:
        - CMD
        - sh
        - -c
        - "printf 'GET /health HTTP/1.0\r\nHost: 127.0.0.1\r\n\r\n' | nc -w4 127.0.0.1 ${RAG_PORT:-8000}"
      interval: 5s
      timeout: 20s
      retries: 10

# ========================================
# Persistent Data Volumes
# ========================================
volumes:
  meilisearch-data:
    name: librechat_meilisearch_data
  vectordb-data:
    name: librechat_vectordb_data
  librechat-images:
    name: librechat_images
  librechat-logs:
    name: librechat_logs
  librechat-uploads:
    name: librechat_uploads
  librechat-config:
    name: librechat_config

# ========================================
# Network Security Configuration
# ========================================
networks:
  # Frontend сеть - для доступа извне
  frontend:
    name: librechat_frontend
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: librechat-frontend
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
    
  # Backend сеть - внутренняя изолированная сеть
  backend:
    name: librechat_backend
    driver: bridge
    internal: true  # НЕТ доступа к внешнему интернету
    driver_opts:
      com.docker.network.bridge.name: librechat-backend
    ipam:
      driver: default
      config:
        - subnet: 172.21.0.0/16
          gateway: 172.21.0.1